name: CI - BUILD

on:
  push:
    branches: 
     - '**'
  pull_request:
    branches:
    - '** '

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create test environment file from .env.example
      run: |
        cp .env.template .env.test
        echo "FERNET_KEY=46BKJoQYlPPOexq0OhDZnIlNepKFf87WFwLbfzqDDho=" >> .env.test
        echo "AIRFLOW_ADMIN_USERNAME=testuser_$(date +%s)" >> .env.test
        echo "AIRFLOW_ADMIN_PASSWORD=testpass_$(date +%s)" >> .env.test
        echo "AIRFLOW_ADMIN_EMAIL=test_$(date +%s)@example.com" >> .env.test

    - name: Build Docker image
      run: |
        docker build \
          --tag airflow-app:latest \
          --file Dockerfile \
          .

    - name: Test Docker image with generated test values
      run: |
        TEST_USER="testuser_$(date +%s)"
        TEST_PASS="testpass_$(date +%s)"
        TEST_EMAIL="test_$(date +%s)@example.com"
        
        docker run --rm -d \
          --name test-airflow \
          -e AIRFLOW_ADMIN_USERNAME="$TEST_USER" \
          -e AIRFLOW_ADMIN_PASSWORD="$TEST_PASS" \
          -e AIRFLOW_ADMIN_EMAIL="$TEST_EMAIL" \
          -e FERNET_KEY="46BKJoQYlPPOexq0OhDZnIlNepKFf87WFwLbfzqDDho=" \
          airflow-app:latest
        
        echo "Waiting for container to initialize..."
        sleep 20
        
        if docker ps | grep -q test-airflow; then
          echo "Container is running successfully"
          echo "Checking startup logs:"
          docker logs test-airflow --tail 10
        else
          echo "Container failed to start"
          docker logs test-airflow
          exit 1
        fi
        
        docker stop test-airflow

    - name: Run security scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: airflow-app:latest
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'

    - name: Log build success
      run: echo "Docker image built and tested successfully"
