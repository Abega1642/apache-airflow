name: CI - BUILD

on:
  push:
    branches: 
     - '**'
  pull_request:
    branches:
    - '** '

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: airflow
          POSTGRES_PASSWORD: airflow
          POSTGRES_DB: airflow
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build \
          --tag airflow-app:latest \
          --file Dockerfile \
          .

    - name: Test Docker image
      run: |
        TEST_USER="testuser_$(date +%s)"
        TEST_PASS="testpass_$(date +%s)"
        TEST_EMAIL="test_$(date +%s)@example.com"
        
        docker run --rm -d \
          --name test-airflow \
          -e AIRFLOW_ADMIN_USERNAME="$TEST_USER" \
          -e AIRFLOW_ADMIN_PASSWORD="$TEST_PASS" \
          -e AIRFLOW_ADMIN_EMAIL="$TEST_EMAIL" \
          -e AIRFLOW__DATABASE__SQL_ALCHEMY_CONN="postgresql+psycopg2://airflow:airflow@host.docker.internal:5432/airflow" \
          --add-host=host.docker.internal:host-gateway \
          airflow-app:latest
        
        echo "Waiting for container to initialize..."
        sleep 30
        
        if docker ps | grep -q test-airflow; then
          echo "Container is running successfully"
          docker logs test-airflow --tail 15
        else
          echo "Container failed to start"
          docker logs test-airflow
          exit 1
        fi
        
        docker stop test-airflow

    - name: Run security scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: airflow-app:latest
        format: 'table'
        exit-code: 0
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'

    - name: Log build success
      run: echo "Docker image built and tested successfully"
